
{-# OPTIONS --allow-unsolved-metas #-}
module rules where

-- DCD NOTES:
-- we want these to be true, and we need to prove them as lemmas
-- e : Ï„ , Ï„ â‰¤ Ï„â€² â†’ e : Ï„â€²
-- v : Ï„ , Ï„ â‰¤ Ï„â€² â†’ v : Ï„â€²

open import lang public

postulate
  _â‰¤áµ£_ : â„ â†’ â„ â†’ Set
  _<áµ£_ : â„ â†’ â„ â†’ Set
  p2r : Priv â†’ â„

  _âˆˆsupport_ : âˆ€ {â„“} {A : Set â„“} â†’ A â†’ ğ’Ÿ A â†’ Set
  nz-support : âˆ€ {â„“} {A : Set â„“} (ğ“‹ : ğ’Ÿ A) (v : A) (r : â„) â†’ v âˆˆsupport ğ“‹ â†’ Pr[ ğ“‹ â©¦ v ]â‰¡[ r ] â†’ ğ•£ 0 <áµ£ r

  bind-support : âˆ€ {â„“} {A B : Set â„“} â†’ (ğ“‹ : ğ’Ÿ A) â†’ (âˆƒ x â¦‚ A ST x âˆˆsupport ğ“‹ â†’ ğ’Ÿ B) â†’ ğ’Ÿ B

mutual

  -- TYPING JUDGEMENT FOR PRIVACY TERMS --
  infix 6 _,_âŠ¢â‚š_â¦‚_,_

  data _,_âŠ¢â‚š_â¦‚_,_ : âˆ€ {N} â†’ Î“[ N ] â†’ Î£[ N ] â†’ PTerm N â†’ Ï„ N â†’ Î£[ N ] â†’ Set where

    -- P-APP
    âŠ¢`papp : âˆ€ {N} {Î£â‚€ : Î£[ N ]} {Î“ : Î“[ N ]} {Î£â‚ : Î£[ N ]} {Î£â‚‚ : Î£[ N ]} {eâ‚ eâ‚‚ : Term N} {Ï„â‚ : Ï„ N} {Ï„â‚‚ : Ï„ (êœ± N)} {p : Priv} {sb : Sens}
      â†’ Î“ , Î£â‚€ âŠ¢ eâ‚ â¦‚ (pÆ›â¦‚ Ï„â‚ âˆ¥ sb â‡’[ zero âˆ” p âˆ· Î£â‚ ] Ï„â‚‚) , zero
      â†’ Î“ , Î£â‚€ âŠ¢ eâ‚‚ â¦‚ Ï„â‚ , Î£â‚‚
      -----------------------------------------------------------
      â†’ Î“ , Î£â‚€ âŠ¢â‚š (eâ‚ `papp eâ‚‚) â¦‚ cut Î£â‚‚ Ï„â‚‚ , (Î£â‚ + ([vec]âŒ‰ Î£â‚‚ âŒˆâ¸¢ p â¸£))


    -- RETURN
    âŠ¢`return : âˆ€ {N} {Î£â‚€ : Î£[ N ]} {Î“ : Î“[ N ]} {Î£ : Î£[ N ]} {e : Term N} {Ï„ : Ï„ N}
      â†’ Î“ , Î£â‚€ âŠ¢ e â¦‚ Ï„ , Î£
      -----------------------------------------------------------
      â†’ Î“ , Î£â‚€ âŠ¢â‚š (`return e) â¦‚ Ï„ , ([vec]âŒ‰ Î£ âŒˆâ¸¢ `âˆ â¸£)

    -- PCASE
    âŠ¢`pcase : âˆ€ {N} {Î“ : Î“[ N ]} {Î£â‚€ : Î£[ N ]} {Î£â‚ Î£â‚â‚ Î£â‚â‚‚ Î£â‚‚ Î£â‚ƒ : Î£[ N ]} {i : idx (êœ± N)} {eâ‚ : Term N} {eâ‚‚ eâ‚ƒ : PTerm (êœ± N)} {Ï„â‚â‚ Ï„â‚â‚‚ Ï„â‚‚ Ï„â‚ƒ Ï„â‚„ : Ï„ N} {pâ‚‚ pâ‚ƒ : Priv}
      â†’ Î“ , Î£â‚€ âŠ¢ eâ‚ â¦‚ Ï„â‚â‚ âˆ¥ zero âˆ” Î£â‚â‚ âŠ• zero âˆ” Î£â‚â‚‚ âˆ¥ Ï„â‚â‚‚ , Î£â‚
      â†’ (mapâ±½ â‡§áµ— (Ï„â‚â‚ âˆ· Î“)) , â‡§Ë¢ Î£â‚€ âŠ¢â‚š eâ‚‚ â¦‚ (â‡§áµ— Ï„â‚‚) , pâ‚‚ âˆ· Î£â‚‚
      â†’ (mapâ±½ â‡§áµ— (Ï„â‚â‚‚ âˆ· Î“)) , â‡§Ë¢ Î£â‚€ âŠ¢â‚š eâ‚ƒ â¦‚ (â‡§áµ— Ï„â‚ƒ) , pâ‚ƒ âˆ· Î£â‚ƒ
      â†’ (cut Î£â‚â‚ (â‡§áµ— Ï„â‚‚)) Ï„[âŠ”] (cut Î£â‚â‚‚ (â‡§áµ— Ï„â‚ƒ)) â‰¡ âŸ¨ Ï„â‚„ âŸ©
    ------------------------------------------------------------------------------------
      â†’ Î“ , Î£â‚€ âŠ¢â‚š pcase eâ‚ of eâ‚‚ âˆ¥ eâ‚ƒ â¦‚ Ï„â‚„ , [vec]âŒ‰ Î£â‚ âŒˆâ¸¢ `âˆ â¸£ + ((([vec]âŒ‰ Î£â‚â‚  âŒˆâ¸¢ pâ‚‚ â¸£) + Î£â‚‚) âŠ” (([vec]âŒ‰ Î£â‚â‚‚  âŒˆâ¸¢ pâ‚ƒ â¸£) + Î£â‚ƒ))

    -- BIND
    âŠ¢`bind : âˆ€ {N} {Î£â‚€ : Î£[ N ]} {Î“ : Î“[ N ]} {Î£â‚ : Î£[ N ]} {Î£â‚‚ : Î£[ N ]} {eâ‚ : PTerm N} {eâ‚‚ : PTerm (êœ± N)} {Ï„â‚ : Ï„ N} {Ï„â‚‚ : Ï„ (êœ± N)} {p : Priv} {sb : Sens}
      â†’ Î“ , Î£â‚€ âŠ¢â‚š eâ‚ â¦‚ Ï„â‚ , Î£â‚
      â†’ (mapâ±½ â‡§áµ— (Ï„â‚ âˆ· Î“)) , (â‡§Ë¢ Î£â‚€) âŠ¢â‚š eâ‚‚ â¦‚ Ï„â‚‚ , `âˆ âˆ· Î£â‚‚
      -----------------------------------------------------------
      â†’ Î“ , Î£â‚€ âŠ¢â‚š (`bind eâ‚ âˆ¥ eâ‚‚) â¦‚ cut zero Ï„â‚‚ , (Î£â‚ + Î£â‚‚)


  -- TYPING JUDGEMENT FOR SENSITIVITY TERMS --
  infix 6 _,_âŠ¢_â¦‚_,_

  data _,_âŠ¢_â¦‚_,_ : âˆ€ {N} â†’ Î“[ N ] â†’ Î£[ N ] â†’ Term N â†’ Ï„ N â†’ Î£[ N ] â†’ Set where

    -- RLIT
    âŠ¢`â„ : âˆ€ {N} {Î“ : Î“[ N ]} {Î£â‚€ : Î£[ N ]} {r : â„•}
        --------------------------------
      â†’ Î“ , Î£â‚€ âŠ¢ (`â„ r) â¦‚ â„T , zero

    -- BLIT
    âŠ¢`ğ”¹ : âˆ€ {N} {Î“ : Î“[ N ]} {Î£â‚€ : Î£[ N ]} {b : ğ”¹}
        --------------------------------
      â†’ Î“ , Î£â‚€ âŠ¢ (`ğ”¹ b) â¦‚ ğ”¹T , zero

    -- PLUS
    âŠ¢_`+_ : âˆ€ {N} {Î“ : Î“[ N ]} {Î£â‚€ : Î£[ N ]} {Î£â‚ Î£â‚‚ : Î£[ N ]} {eâ‚ eâ‚‚ : Term N}
        â†’ Î“ , Î£â‚€ âŠ¢ eâ‚ â¦‚ â„T , Î£â‚
        â†’ Î“ , Î£â‚€ âŠ¢ eâ‚‚ â¦‚ â„T , Î£â‚‚
        --------------------------------
        â†’ Î“ , Î£â‚€ âŠ¢ eâ‚ `+ eâ‚‚ â¦‚ â„T , Î£â‚ + Î£â‚‚

    -- TIMES
    âŠ¢_`Ã—_ : âˆ€ {N} {Î“ : Î“[ N ]} {Î£â‚€ : Î£[ N ]} {Î£â‚ Î£â‚‚ : Î£[ N ]} {eâ‚ eâ‚‚ : Term N}
        â†’ Î“ , Î£â‚€ âŠ¢ eâ‚ â¦‚ â„T , Î£â‚
        â†’ Î“ , Î£â‚€ âŠ¢ eâ‚‚ â¦‚ â„T , Î£â‚‚
        --------------------------------
        â†’ Î“ , Î£â‚€ âŠ¢ eâ‚ `Ã— eâ‚‚ â¦‚ â„T , [vec]âŒ‰ (Î£â‚ + Î£â‚‚) âŒˆâ¸¢ `âˆ â¸£

    -- LEQ
    âŠ¢_`â‰¤_ : âˆ€ {N} {Î“ : Î“[ N ]} {Î£â‚€ : Î£[ N ]} {Î£â‚ Î£â‚‚ : Î£[ N ]} {eâ‚ eâ‚‚ : Term N}
        â†’ Î“ , Î£â‚€ âŠ¢ eâ‚ â¦‚ â„T , Î£â‚
        â†’ Î“ , Î£â‚€ âŠ¢ eâ‚‚ â¦‚ â„T , Î£â‚‚
        --------------------------------
        â†’ Î“ , Î£â‚€ âŠ¢ eâ‚ `â‰¤ eâ‚‚ â¦‚ ğ”¹T , [vec]âŒ‰ (Î£â‚ + Î£â‚‚) âŒˆâ¸¢ `âˆ â¸£

    -- VAR
    âŠ¢`var_ : âˆ€ {N} {Î“ : Î“[ N ]} {Î£â‚€ : Î£[ N ]} {Î£ : Î£[ N ]} {i : idx N} {Ï„ : Ï„ N} -- {s : Sens}
      â†’ Î“ #[ i ] â‰¡ Ï„
      -- DCD: will need this for weakening
      -- âŸ¨ 1 âŸ© â‰¤ s
      --------------------------------------------------
      â†’ Î“ , Î£â‚€ âŠ¢  ` i â¦‚ Ï„ , Î£ + zero #[ i â†¦ âŸ¨ 1 âŸ© ]
      -- â†’ Î“ , Î£â‚€ âŠ¢  ` i â¦‚ Ï„ , Î£ + zero #[ i â†¦ s ]

    -- UNIT
    âŠ¢`tt : âˆ€ {N} {Î“ : Î“[ N ]} {Î£â‚€ : Î£[ N ]} {i : idx N} -- {Ï„ : Ï„ N}
      --------------------------------------------------
      â†’ Î“ , Î£â‚€ âŠ¢  tt â¦‚ unit , zero

    -- INL
    âŠ¢`inl : âˆ€ {N} {Î“ : Î“[ N ]} {Î£â‚€ : Î£[ N ]} {Î£â‚ : Î£[ N ]} {Î£â‚‚ : Î£[ N ]} {e : Term N} {Ï„â‚ Ï„â‚‚ : Ï„ N}
      â†’ Î“ , Î£â‚€ âŠ¢ e â¦‚ Ï„â‚ , Î£â‚
      --------------------------------------------------
      â†’ Î“ , Î£â‚€ âŠ¢ (inl Ï„â‚‚ âˆ¥ e) â¦‚ (Ï„â‚ âˆ¥ zero âˆ” Î£â‚ âŠ• zero âˆ” zero âˆ¥ Ï„â‚‚) , zero

    -- INR
    âŠ¢`inr : âˆ€ {N} {Î“ : Î“[ N ]} {Î£â‚€ : Î£[ N ]} {Î£â‚‚ : Î£[ N ]} {e : Term N} {Ï„â‚ Ï„â‚‚ : Ï„ N}
      â†’ Î“ , Î£â‚€ âŠ¢ e â¦‚ Ï„â‚‚ , Î£â‚‚
      --------------------------------------------------
      â†’ Î“ , Î£â‚€ âŠ¢ (inr Ï„â‚ âˆ¥ e) â¦‚ Ï„â‚ âˆ¥ zero âˆ” zero âŠ• zero âˆ” Î£â‚‚ âˆ¥ Ï„â‚‚  , zero

    -- CASE
    âŠ¢`case : âˆ€ {N} {Î“ : Î“[ N ]} {Î£â‚€ : Î£[ N ]} {Î£â‚ Î£â‚â‚ Î£â‚â‚‚ Î£â‚‚ Î£â‚ƒ : Î£[ N ]} {i : idx (êœ± N)} {eâ‚ : Term N} {eâ‚‚ eâ‚ƒ : Term (êœ± N)} {Ï„â‚â‚ Ï„â‚â‚‚ Ï„â‚‚ Ï„â‚ƒ Ï„â‚„ : Ï„ N} {sâ‚‚ sâ‚ƒ : Sens}
      â†’ Î“ , Î£â‚€ âŠ¢ eâ‚ â¦‚ Ï„â‚â‚ âˆ¥ zero âˆ” Î£â‚â‚ âŠ• zero âˆ” Î£â‚â‚‚ âˆ¥ Ï„â‚â‚‚ , Î£â‚
      â†’ (mapâ±½ â‡§áµ— (Ï„â‚â‚ âˆ· Î“)) , â‡§Ë¢ Î£â‚€ âŠ¢ eâ‚‚ â¦‚ (â‡§áµ— Ï„â‚‚) , sâ‚‚ âˆ· Î£â‚‚
      â†’ (mapâ±½ â‡§áµ— (Ï„â‚â‚‚ âˆ· Î“)) , â‡§Ë¢ Î£â‚€ âŠ¢ eâ‚ƒ â¦‚ (â‡§áµ— Ï„â‚ƒ) , sâ‚ƒ âˆ· Î£â‚ƒ
      â†’ (cut (Î£â‚ + Î£â‚â‚) (â‡§áµ— Ï„â‚‚)) Ï„[âŠ”] (cut (Î£â‚ + Î£â‚â‚‚) (â‡§áµ— Ï„â‚ƒ)) â‰¡ âŸ¨ Ï„â‚„ âŸ©
    ------------------------------------------------------------------------------------
      â†’ Î“ , Î£â‚€ âŠ¢ case eâ‚ of eâ‚‚ âˆ¥ eâ‚ƒ â¦‚ Ï„â‚„ , [vec]âŒ‰ Î£â‚ âŒˆâ¸¢ `âˆ â¸£ + ((sâ‚‚ â¨µ Î£â‚â‚) + Î£â‚‚) âŠ” ((sâ‚ƒ â¨µ Î£â‚â‚‚) + Î£â‚ƒ)

    -- IF
    âŠ¢`if : âˆ€ {N} {Î“ : Î“[ N ]} {Î£â‚€ : Î£[ N ]} {Î£â‚ Î£â‚‚ Î£â‚ƒ : Î£[ N ]} {eâ‚ eâ‚‚ eâ‚ƒ : Term N}  {Ï„ : Ï„ N}
      â†’ Î“ , Î£â‚€ âŠ¢ eâ‚ â¦‚ ğ”¹T , Î£â‚
      â†’ Î“ , Î£â‚€ âŠ¢ eâ‚‚ â¦‚ Ï„ , Î£â‚‚
      â†’ Î“ , Î£â‚€ âŠ¢ eâ‚ƒ â¦‚ Ï„ , Î£â‚ƒ
    ------------------------------------------------------------------------------------
      â†’ Î“ , Î£â‚€ âŠ¢ if eâ‚ âˆ¥ eâ‚‚ âˆ¥ eâ‚ƒ â¦‚ Ï„ , Î£â‚ + (Î£â‚‚ âŠ” Î£â‚ƒ)

    -- LET
    âŠ¢`let : âˆ€ {N} {Î“ : Î“[ N ]} {Î£â‚€ : Î£[ N ]} {Î£â‚ Î£â‚‚ : Î£[ N ]} {eâ‚ : Term N} {eâ‚‚ : Term (êœ± N)} {Ï„â‚ : Ï„ N} {Ï„â‚‚ : Ï„ (êœ± N)} {s : Sens}
      â†’  Î“ , Î£â‚€ âŠ¢ eâ‚ â¦‚ Ï„â‚ , Î£â‚
      â†’  (mapâ±½ â‡§áµ— (Ï„â‚ âˆ· Î“)) , â‡§Ë¢ Î£â‚€ âŠ¢ eâ‚‚ â¦‚ Ï„â‚‚ , s âˆ· Î£â‚‚
      -----------------------------------------------
      â†’ Î“ , Î£â‚€ âŠ¢ (`let eâ‚ âˆ¥ eâ‚‚) â¦‚  cut Î£â‚ Ï„â‚‚ , (s â¨µ Î£â‚) + Î£â‚‚

    -- S-LAM
    âŠ¢`sÎ» : âˆ€ {N} {Î“ : Î“[ N ]} {Î£â‚€ : Î£[ N ]} {s : Sens} {Î£â‚ : Î£[ N ]} {i : idx N} {e : Term (êœ± N)} {Ï„â‚ : Ï„ N} {Ï„â‚‚ : Ï„ (êœ± N)} {sb : Sens}
      â†’  (mapâ±½ â‡§áµ— (Ï„â‚ âˆ· Î“)) , sb âˆ· Î£â‚€ âŠ¢ e â¦‚ Ï„â‚‚ , s âˆ· Î£â‚
      -----------------------------------------------
      â†’ Î“ , Î£â‚€ âŠ¢ (sÆ›â¦‚ Ï„â‚ âˆ¥ sb â‡’ e) â¦‚ (sÆ›â¦‚ Ï„â‚ âˆ¥ sb â‡’[ zero âˆ” s âˆ· Î£â‚ ] Ï„â‚‚) , zero

    -- P-LAM
    âŠ¢`pÎ» : âˆ€ {N} {Î“ : Î“[ N ]} {Î£â‚€ : Î£[ N ]} {p : Priv} {Î£â‚ : Î£â‚š[ N ]} {i : idx N} {e : PTerm (êœ± N)} {Ï„â‚ : Ï„ N} {Ï„â‚‚ : Ï„ (êœ± N)} {sb : Sens}
      â†’  (mapâ±½ â‡§áµ— (Ï„â‚ âˆ· Î“)) , sb âˆ· Î£â‚€ âŠ¢â‚š e â¦‚ Ï„â‚‚ , p âˆ· Î£â‚
      -----------------------------------------------
      â†’ Î“ , Î£â‚€ âŠ¢ (pÆ›â¦‚ Ï„â‚ âˆ¥ sb â‡’ e) â¦‚ (pÆ›â¦‚ Ï„â‚ âˆ¥ sb â‡’[ zero âˆ” p âˆ· Î£â‚ ] Ï„â‚‚) , zero

    -- S-APP
    âŠ¢`app : âˆ€ {N} {i : idx (êœ± N)} {Î£â‚€ : Î£[ N ]} {Î“ : Î“[ N ]} {Î£â‚ Î£â‚‚ : Î£[ N ]} {eâ‚ eâ‚‚ : Term N} {Ï„â‚ : Ï„ N} {Ï„â‚‚ : Ï„ (êœ± N)} {s sb : Sens}
      â†’ Î“ , Î£â‚€ âŠ¢ eâ‚ â¦‚ (sÆ›â¦‚ Ï„â‚ âˆ¥ sb â‡’[ zero âˆ” s âˆ· Î£â‚ ] Ï„â‚‚) , zero
      â†’ Î“ , Î£â‚€ âŠ¢ eâ‚‚ â¦‚ Ï„â‚ , Î£â‚‚
      -----------------------------------------------------------
      â†’ Î“ , Î£â‚€ âŠ¢ (eâ‚ `app eâ‚‚) â¦‚ cut Î£â‚‚ Ï„â‚‚ , (Î£â‚ + (s â¨µ Î£â‚‚))

    -- PAIR
    âŠ¢`_pair_ : âˆ€ {N} {Î“ : Î“[ N ]} {Î£â‚€ : Î£[ N ]} {Î£â‚ Î£â‚‚ : Î£[ N ]} {eâ‚ eâ‚‚ : Term N} {Ï„â‚ Ï„â‚‚ : Ï„ N}
      â†’ Î“ , Î£â‚€ âŠ¢ eâ‚ â¦‚ Ï„â‚ , Î£â‚
      â†’ Î“ , Î£â‚€ âŠ¢ eâ‚‚ â¦‚ Ï„â‚‚ , Î£â‚‚
      -----------------------------------------------------------
      â†’ Î“ , Î£â‚€ âŠ¢ eâ‚ `pair eâ‚‚ â¦‚ Ï„â‚ âˆ¥ zero âˆ” Î£â‚ âŠ— zero âˆ” Î£â‚‚ âˆ¥ Ï„â‚‚ , zero

    -- PROJ1
    âŠ¢`fst : âˆ€ {N} {Î“ : Î“[ N ]} {Î£â‚€ : Î£[ N ]} {Î£ Î£â‚ Î£â‚‚ : Î£[ N ]} {e : Term N} {Ï„â‚ Ï„â‚‚ : Ï„ N}
      â†’ Î“ , Î£â‚€ âŠ¢ e â¦‚ Ï„â‚ âˆ¥ zero âˆ” Î£â‚ âŠ— zero âˆ” Î£â‚‚ âˆ¥ Ï„â‚‚ , Î£
    --------------------------------------
      â†’ Î“ , Î£â‚€ âŠ¢ fst e â¦‚ Ï„â‚ , Î£ + Î£â‚

    -- PROJ2
    âŠ¢`snd : âˆ€ {N} {Î“ : Î“[ N ]} {Î£â‚€ : Î£[ N ]} {Î£ Î£â‚ Î£â‚‚ : Î£[ N ]} {e : Term N} {Ï„â‚ Ï„â‚‚ : Ï„ N}
      â†’ Î“ , Î£â‚€ âŠ¢ e â¦‚ Ï„â‚ âˆ¥ zero âˆ” Î£â‚ âŠ— zero âˆ” Î£â‚‚ âˆ¥ Ï„â‚‚ , Î£
    -----------------------------------------
      â†’ Î“ , Î£â‚€ âŠ¢ snd e â¦‚ Ï„â‚‚ , Î£ + Î£â‚‚

two : Term 0
two = `â„ 2

âŠ¢two : âˆ€ {Î“ : Î“[ 0 ]} â†’ Î“ , zero âŠ¢ two â¦‚ â„T , []
âŠ¢two = âŠ¢`â„

_ : âŸ¬ â„• âŸ­[ 2 ]
_ = 1 âˆ· 0 âˆ· []

_ : âŸ¬ â„• âŸ­[ 2 ]
_ = 1 âˆ· 0 âˆ· [] + 1 âˆ· 0 âˆ· []

_ : (1 âˆ· 0 âˆ· [] AT âŸ¬ â„• âŸ­[ 2 ]) + (1 âˆ· 0 âˆ· [] AT âŸ¬ â„• âŸ­[ 2 ]) â‰¡ (2 âˆ· 0 âˆ· [])
_ = â†¯

postulate
  âˆ£_-_âˆ£ : â„• â†’ â„• â†’ â„•

-- â„¾[ N ] =  Î“[ N ]

-- TYPING JUDGEMENT FOR VALUE ENVIRONMENT --

mutual
  infix 6 _âŠ¢_

  data _âŠ¢_ : âˆ€ {N} â†’ â„¾[ N ] â†’ Î³[ N ] â†’ Set where

    âŠ¢z : [] âŠ¢ []

    âŠ¢s : âˆ€ {N} {â„¾ : â„¾[ N ]} {Î³ : Î³[ N ]} {ğ“‹ : ğ“‹} {Ï„ : Ï„ 0}
      â†’ âŠ¢ ğ“‹ â¦‚ Ï„
      â†’ â„¾ âŠ¢ Î³
      --------------------------------
      â†’ (Ï„ âˆ· â„¾) âŠ¢ ğ“‹ âˆ· Î³

  -- TYPING JUDGEMENT FOR VALUES --
  infix 6 âŠ¢_â¦‚_

  data âŠ¢_â¦‚_ : ğ“‹ â†’ Ï„ á´¢ â†’ Set where

    âŠ¢ğ“‡ : âˆ€ {r : â„•}
        --------------------------------
      â†’ âŠ¢ (ğ“‡ r) â¦‚ â„T

    âŠ¢ğ’· : âˆ€ {b : ğ”¹}
        --------------------------------
      â†’ âŠ¢ (ğ’· b) â¦‚ ğ”¹T

    âŠ¢tt :
        --------------------------------
        âŠ¢ tt â¦‚ unit

    âŠ¢inl : âˆ€ {v Ï„â‚ Ï„â‚‚ sâ‚ sâ‚‚}
      â†’ âŠ¢ v â¦‚ Ï„â‚
        --------------------------------
      â†’ âŠ¢ (inl v) â¦‚ Ï„â‚ âˆ¥ sâ‚ âˆ” zero âŠ• sâ‚‚ âˆ” zero âˆ¥ Ï„â‚‚

    âŠ¢inr : âˆ€ {v Ï„â‚ Ï„â‚‚ sâ‚ sâ‚‚}
      â†’ âŠ¢ v â¦‚ Ï„â‚‚
        --------------------------------
      â†’ âŠ¢ (inr v) â¦‚ Ï„â‚ âˆ¥ sâ‚ âˆ” zero âŠ• sâ‚‚ âˆ” zero âˆ¥ Ï„â‚‚

    âŠ¢pair : âˆ€ {vâ‚ vâ‚‚ Ï„â‚ Ï„â‚‚ sâ‚ sâ‚‚}
      â†’ âŠ¢ vâ‚ â¦‚ Ï„â‚
      â†’ âŠ¢ vâ‚‚ â¦‚ Ï„â‚‚
        --------------------------------
      â†’ âŠ¢ (vâ‚ pair vâ‚‚) â¦‚ Ï„â‚ âˆ¥ sâ‚ âˆ” zero âŠ— sâ‚‚ âˆ” zero âˆ¥ Ï„â‚‚

    âŠ¢sÎ» : âˆ€ {N} {Î“ : Î“[ N ]} {Î£â‚€ : Î£[ N ]} {e : Term (êœ± N)} {Î³ : Î³[ N ]} {Ï„â‚ : Ï„ N} {Ï„â‚‚ : Ï„ (êœ± N)} {Ï„â‚â€² Ï„â‚‚â€²} {s sâ€² sb} {Î£ : Î£[ N ]}
      â†’ mapâ±½ (instantiateÎ£/Ï„ zero) Î“ âŠ¢ Î³
      â†’ Î“ , Î£â‚€ âŠ¢ sÆ›â¦‚ Ï„â‚ âˆ¥ sb â‡’ e â¦‚ (sÆ›â¦‚ Ï„â‚ âˆ¥ sb â‡’[ zero âˆ” s âˆ· Î£ ] Ï„â‚‚) , zero
      â†’ Ï„â‚â€² â‰¡ instantiateÎ£/Ï„ zero Ï„â‚
      â†’ Ï„â‚‚â€² â‰¡ instantiateÎ£/Ï„ zero Ï„â‚‚
      â†’ sâ€² â‰¡ zero
        --------------------------------
      â†’ âŠ¢ (sÆ›â¦‚ e âˆ¥ Î³ ) â¦‚ (sÆ›â¦‚ Ï„â‚â€² âˆ¥ sb â‡’[ sâ€² âˆ” [ s ] ] Ï„â‚‚â€²)

    âŠ¢pÎ» : âˆ€ {N} {Î“ : Î“[ N ]} {Î£â‚€ : Î£[ N ]} {e : PTerm (êœ± N)} {Î³ : Î³[ N ]} {Ï„â‚ : Ï„ N} {Ï„â‚‚ : Ï„ (êœ± N)} {Ï„â‚â€² Ï„â‚‚â€²} {p pâ€² sb} {Î£ : Î£â‚š[ N ]}
      â†’ mapâ±½ (instantiateÎ£/Ï„ zero) Î“ âŠ¢ Î³
      â†’ Î“ , Î£â‚€ âŠ¢ pÆ›â¦‚ Ï„â‚ âˆ¥ sb â‡’ e â¦‚ (pÆ›â¦‚ Ï„â‚ âˆ¥ sb â‡’[ zero âˆ” p âˆ· Î£ ] Ï„â‚‚) , zero
      â†’ Ï„â‚â€² â‰¡ instantiateÎ£/Ï„ zero Ï„â‚
      â†’ Ï„â‚‚â€² â‰¡ instantiateÎ£/Ï„ zero Ï„â‚‚
      â†’ pâ€² â‰¡ L1N Î£
        --------------------------------
      â†’ âŠ¢ (pÆ›â¦‚ e âˆ¥ Î³ ) â¦‚ (pÆ›â¦‚ Ï„â‚â€² âˆ¥ sb â‡’[ pâ€² âˆ” [ p ] ] Ï„â‚‚â€²)

-- postulate
--   -- sensitivity evaluation
--   âŸ¦_Ë_âŸ§Ë¢[_Ë_] : âˆ€ {N} {Î“ : Î“[ N ]} {â„¾ Î£â‚€ Ï„ Î£ Î£â€²} â†’ (e : Term N) â†’ (âŠ¢e : Î“ , Î£â‚€ âŠ¢ e â¦‚ Ï„ , Î£) â†’ (Î³ : Î³[ N ]) â†’ â„¾ âŠ¢ Î³ â†’ âˆƒ v â¦‚ ğ“‹ ST âŠ¢ v â¦‚  Î£â€² âŸ¨âŸ¨ Ï„ âŸ©âŸ©
--   corr : âˆ€ {N} {Î“ : Î“[ N ]} {â„¾ Î£â‚€ Ï„ Î£ Î£â€² v âŠ¢v} â†’ (e : Term N) â†’ (âŠ¢e : (Î“ , Î£â‚€ âŠ¢ e â¦‚ Ï„ , Î£ )) â†’ (Î³ : Î³[ N ]) â†’ (âŠ¢Î³ : â„¾ âŠ¢ Î³) â†’ Î³ âŠ¢ e â‡“ v â†’ âŸ¦ e Ë âŠ¢e âŸ§Ë¢[ Î³ Ë âŠ¢Î³ ] â‰¡ âŸ¨âˆƒ v , âŠ¢v âŸ©
--
-- -- privacy evaluation
--
--
-- âŸ¦_Ë_âŸ§áµ–[_Ë_] : âˆ€ {N} {Î“ : Î“[ N ]} {â„¾ Î£â‚€ e Ï„ Î£ Î£â€²} â†’ (e : PTerm N) â†’ Î“ , Î£â‚€ âŠ¢â‚š e â¦‚ Ï„ , Î£ â†’ (Î³ : Î³[ N ]) â†’ â„¾ âŠ¢ Î³ â†’ ğ’Ÿ (âˆƒ v â¦‚ ğ“‹ ST âŠ¢ v â¦‚ Î£â€² âŸ¨âŸ¨ Ï„ âŸ©âŸ©)
-- âŸ¦_Ë_âŸ§áµ–[_Ë_] {N = N} (_`papp_ eâ‚ eâ‚‚) (âŠ¢`papp Î´â‚ Î´â‚‚) Î³  âŠ¢Î³
--   with âŸ¦ eâ‚ Ë Î´â‚ âŸ§Ë¢[ Î³ Ë âŠ¢Î³ ] | âŸ¦ eâ‚‚ Ë Î´â‚‚ âŸ§Ë¢[ Î³ Ë âŠ¢Î³ ]
-- ... | âŸ¨âˆƒ  (pÆ›â¦‚ eâ€² âˆ¥ Î³â€²) , (âŠ¢pÎ» {N = Nâ‚} âŠ¢Î³â€² âŠ¢eâ€² iâ‚ iâ‚‚ pz) âŸ© | âŸ¨âˆƒ v , âŠ¢v âŸ© = âŸ¦ {! eâ€² !} Ë {!âŠ¢eâ€²   !} âŸ§áµ–[ {!   !} Ë {!   !} ]

mutual

  -- PROBABILISTIC SEMANTICS

  infix 6 _âŠ¢_â‡“â‚š_

  data _âŠ¢_â‡“â‚š_ : âˆ€ {N} â†’ Î³[ N ] â†’ PTerm N â†’ ğ’Ÿ ğ“‹ â†’ Set where

    -- APP
    âŠ¢`papp : âˆ€ {N} {Î³ : Î³[ N ]} {eâ€² : PTerm (êœ± N)} {eâ‚ eâ‚‚ : Term N} {ğ“‹â‚ : ğ“‹} {ğ“‹â‚‚ : ğ’Ÿ ğ“‹}
      â†’ Î³ âŠ¢ eâ‚ â‡“ (pÆ›â¦‚ eâ€² âˆ¥ Î³ )
      â†’ Î³ âŠ¢ eâ‚‚ â‡“ ğ“‹â‚
      â†’ ğ“‹â‚ âˆ· Î³ âŠ¢ eâ€² â‡“â‚š ğ“‹â‚‚
      -----------------------------------------------------------
      â†’ Î³ âŠ¢ (eâ‚ `papp eâ‚‚) â‡“â‚š ğ“‹â‚‚

    -- RETURN
    âŠ¢`return : âˆ€ {N} {Î³ : Î³[ N ]} {e : Term N} {ğ“‹â‚ : ğ“‹}
      â†’ Î³ âŠ¢ e â‡“ ğ“‹â‚
      -----------------------------------------------------------
      â†’ Î³ âŠ¢ (`return e) â‡“â‚š return ğ“‹â‚

    -- PCASE-LEFT
    âŠ¢`pcase/l : âˆ€ {N} {Î³ : Î³[ N ]} {eâ‚ : Term N} {eâ‚‚ eâ‚ƒ : PTerm (êœ± N)} {ğ“‹â‚ : ğ“‹} {ğ“‹â‚‚ : ğ’Ÿ ğ“‹}
      â†’ Î³ âŠ¢ eâ‚ â‡“ inl ğ“‹â‚
      â†’ (ğ“‹â‚ âˆ· Î³) âŠ¢ eâ‚‚ â‡“â‚š ğ“‹â‚‚
    ------------------------------------------------------------------------------------
      â†’ Î³ âŠ¢ pcase eâ‚ of eâ‚‚ âˆ¥ eâ‚ƒ â‡“â‚š ğ“‹â‚‚

    -- PCASE-RIGHT
    âŠ¢`pcase/r : âˆ€ {N} {Î³ : Î³[ N ]} {eâ‚ : Term N} {eâ‚‚ eâ‚ƒ : PTerm (êœ± N)} {ğ“‹â‚ : ğ“‹} {ğ“‹â‚‚ : ğ’Ÿ ğ“‹}
      â†’ Î³ âŠ¢ eâ‚ â‡“ inr ğ“‹â‚
      â†’ (ğ“‹â‚ âˆ· Î³) âŠ¢ eâ‚ƒ â‡“â‚š ğ“‹â‚‚
    ------------------------------------------------------------------------------------
      â†’ Î³ âŠ¢ pcase eâ‚ of eâ‚‚ âˆ¥ eâ‚ƒ â‡“â‚š ğ“‹â‚‚


    -- BIND
    -- bind-support : âˆ€ {â„“} {A B : Set â„“} â†’ (ğ“‹ : ğ’Ÿ A) â†’ (âˆƒ x â¦‚ A ST x âˆˆsupport ğ“‹ â†’ ğ’Ÿ B) â†’ ğ’Ÿ B
    âŠ¢`bind : âˆ€ {N} {Î³ : Î³[ N ]} {eâ‚‚ : PTerm (êœ± N)} {eâ‚ : PTerm N} {ğ“‹â‚ : ğ’Ÿ ğ“‹}
      â†’ Î³ âŠ¢ eâ‚ â‡“â‚š ğ“‹â‚
      â†’ (F : âˆ€ vâ‚ â†’ vâ‚ âˆˆsupport ğ“‹â‚ â†’ âˆƒ ğ“‹â‚‚ ST vâ‚ âˆ· Î³ âŠ¢ eâ‚‚ â‡“â‚š ğ“‹â‚‚)
      â†’ let ğ“‹â‚ƒ =
              let _>>=_ = bind-support
              in do
                vâ‚Îµ â† ğ“‹â‚ -- âŸ¨âˆƒ vâ‚ , Îµ âŸ© â† ğ“‹â‚
                let âŸ¨âˆƒ vâ‚ , Îµ âŸ© = vâ‚Îµ in dÏ€â‚ (F vâ‚ Îµ)
        in
      -----------------------------------------------------------
      Î³ âŠ¢ (`bind eâ‚ âˆ¥ eâ‚‚) â‡“â‚š ğ“‹â‚ƒ

  -- GROUND TRUTH DYNAMIC SEMANTICS

  infix 6 _âŠ¢_â‡“_

  data _âŠ¢_â‡“_ : âˆ€ {N} â†’ Î³[ N ] â†’ Term N â†’ ğ“‹ â†’ Set where

    -- RLIT
    âŠ¢`â„ : âˆ€ {N} {Î³ : Î³[ N ]} {r : â„•}
        --------------------------------
      â†’ Î³ âŠ¢ (`â„ r) â‡“ ğ“‡ r

    -- BLIT
    âŠ¢`ğ”¹ : âˆ€ {N} {Î³ : Î³[ N ]} {b : ğ”¹}
        --------------------------------
      â†’ Î³ âŠ¢ (`ğ”¹ b) â‡“ ğ’· b

    -- PLUS
    âŠ¢_`+_ : âˆ€ {N} {Î³ : Î³[ N ]} {eâ‚ eâ‚‚ : Term N} {râ‚ râ‚‚ : â„•}
        â†’ Î³ âŠ¢ eâ‚ â‡“ ğ“‡ râ‚
        â†’ Î³ âŠ¢ eâ‚‚ â‡“ ğ“‡ râ‚‚
        --------------------------------
        â†’ Î³ âŠ¢ eâ‚ `+ eâ‚‚ â‡“ ğ“‡ (râ‚ + râ‚‚)

    -- TIMES
    âŠ¢_`Ã—_ : âˆ€ {N} {Î³ : Î³[ N ]}  {eâ‚ eâ‚‚ : Term N} {râ‚ râ‚‚ : â„•}
        â†’ Î³ âŠ¢ eâ‚ â‡“ ğ“‡ râ‚
        â†’ Î³ âŠ¢ eâ‚‚ â‡“ ğ“‡ râ‚‚
        --------------------------------
        â†’ Î³ âŠ¢ eâ‚ `Ã— eâ‚‚ â‡“ ğ“‡ (râ‚ Ã— râ‚‚)

    -- LEQ
    âŠ¢_`â‰¤_ : âˆ€ {N} {Î³ : Î³[ N ]}  {eâ‚ eâ‚‚ : Term N} {râ‚ râ‚‚ : â„•}
        â†’ Î³ âŠ¢ eâ‚ â‡“ ğ“‡ râ‚
        â†’ Î³ âŠ¢ eâ‚‚ â‡“ ğ“‡ râ‚‚
        --------------------------------
        â†’ Î³ âŠ¢ eâ‚ `â‰¤ eâ‚‚ â‡“ ğ’· (râ‚ â‰¤? râ‚‚)

    -- VAR
    âŠ¢`var_ : âˆ€ {N} {Î³ : Î³[ N ]} {i : idx N} {ğ“‹ : ğ“‹}
      â†’ Î³ #[ i ] â‰¡ ğ“‹
      --------------------------------------------------
      â†’ Î³ âŠ¢  ` i â‡“ ğ“‹

    -- UNIT
    âŠ¢`tt : âˆ€ {N} {Î³ : Î³[ N ]}
      ----------------------------
      â†’ Î³ âŠ¢  tt â‡“ tt

    -- INL
    âŠ¢`inl : âˆ€ {N} {Î³ : Î³[ N ]} {e : Term N} {ğ“‹ : ğ“‹} {Ï„â‚‚ : Ï„ N}
      â†’ Î³ âŠ¢ e â‡“ ğ“‹
      --------------------------------------------------
      â†’ Î³ âŠ¢ (inl Ï„â‚‚ âˆ¥ e) â‡“ inl ğ“‹

    -- INR
    âŠ¢`inr : âˆ€ {N} {Î³ : Î³[ N ]} {e : Term N} {ğ“‹ : ğ“‹} {Ï„â‚ : Ï„ N}
      â†’ Î³ âŠ¢ e â‡“ ğ“‹
      --------------------------------------------------
      â†’ Î³ âŠ¢ (inr Ï„â‚ âˆ¥ e) â‡“ inr ğ“‹

    -- CASE-LEFT
    âŠ¢`case/l : âˆ€ {N} {Î³ : Î³[ N ]} {eâ‚ : Term N} {eâ‚‚ eâ‚ƒ : Term (êœ± N)} {ğ“‹â‚ ğ“‹â‚‚ : ğ“‹}
      â†’ Î³ âŠ¢ eâ‚ â‡“ inl ğ“‹â‚
      â†’ (ğ“‹â‚ âˆ· Î³) âŠ¢ eâ‚‚ â‡“ ğ“‹â‚‚
    ------------------------------------------------------------------------------------
      â†’ Î³ âŠ¢ case eâ‚ of eâ‚‚ âˆ¥ eâ‚ƒ â‡“ ğ“‹â‚‚

    -- CASE-RIGHT
    âŠ¢`case/r : âˆ€ {N} {Î³ : Î³[ N ]} {eâ‚ : Term N} {eâ‚‚ eâ‚ƒ : Term (êœ± N)} {ğ“‹â‚ ğ“‹â‚‚ : ğ“‹}
      â†’ Î³ âŠ¢ eâ‚ â‡“ inr ğ“‹â‚
      â†’ (ğ“‹â‚ âˆ· Î³) âŠ¢ eâ‚ƒ â‡“ ğ“‹â‚‚
    ------------------------------------------------------------------------------------
      â†’ Î³ âŠ¢ case eâ‚ of eâ‚‚ âˆ¥ eâ‚ƒ â‡“ ğ“‹â‚‚

    -- IF-TRUE
    âŠ¢`if-true : âˆ€ {N} {Î³ : Î³[ N ]} {eâ‚ eâ‚‚ eâ‚ƒ : Term N} {ğ“‹ : ğ“‹}
      â†’ Î³ âŠ¢ eâ‚ â‡“ ğ’· Éª
      â†’ Î³ âŠ¢ eâ‚‚ â‡“ ğ“‹
    ------------------------------------------------------------------------------------
      â†’ Î³ âŠ¢ if eâ‚ âˆ¥ eâ‚‚ âˆ¥ eâ‚ƒ â‡“ ğ“‹

    -- IF-FALSE
    âŠ¢`if-false : âˆ€ {N} {Î³ : Î³[ N ]} {eâ‚ eâ‚‚ eâ‚ƒ : Term N} {ğ“‹ : ğ“‹}
      â†’ Î³ âŠ¢ eâ‚ â‡“ ğ’· á´
      â†’ Î³ âŠ¢ eâ‚ƒ â‡“ ğ“‹
    ------------------------------------------------------------------------------------
      â†’ Î³ âŠ¢ if eâ‚ âˆ¥ eâ‚‚ âˆ¥ eâ‚ƒ â‡“ ğ“‹

    -- LET
    âŠ¢`let : âˆ€ {N} {Î³ : Î³[ N ]} {eâ‚ : Term N} {eâ‚‚ : Term (êœ± N)} {ğ“‹â‚ ğ“‹â‚‚ : ğ“‹}
      â†’  Î³ âŠ¢ eâ‚ â‡“ ğ“‹â‚
      â†’  (ğ“‹â‚ âˆ· Î³) âŠ¢ eâ‚‚ â‡“ ğ“‹â‚‚
      -----------------------------------------------
      â†’ Î³ âŠ¢ (`let eâ‚ âˆ¥ eâ‚‚) â‡“ ğ“‹â‚‚

    -- LAM
    âŠ¢`Î» : âˆ€ {N} {Î³ : Î³[ N ]} {e : Term (êœ± N)} {Ï„ : Ï„ N} {s : Sens}
      -----------------------------------------------
      â†’ Î³ âŠ¢ (sÆ›â¦‚ Ï„ âˆ¥ s â‡’ e) â‡“ (sÆ›â¦‚ e âˆ¥ Î³ )


    -- P-LAM
    âŠ¢`pÎ» : âˆ€ {N} {Î³ : Î³[ N ]} {e : PTerm (êœ± N)} {Ï„ : Ï„ N} {s : Sens}
      -----------------------------------------------
      â†’ Î³ âŠ¢ (pÆ›â¦‚ Ï„ âˆ¥ s â‡’ e) â‡“ (pÆ›â¦‚ e âˆ¥ Î³ )

    -- APP
    âŠ¢`app : âˆ€ {N} {Î³ : Î³[ N ]} {eâ€² : Term (êœ± N)} {eâ‚ eâ‚‚ : Term N} {ğ“‹â‚ ğ“‹â‚‚ : ğ“‹}
      â†’ Î³ âŠ¢ eâ‚ â‡“ (sÆ›â¦‚ eâ€² âˆ¥ Î³ )
      â†’ Î³ âŠ¢ eâ‚‚ â‡“ ğ“‹â‚
      â†’ ğ“‹â‚ âˆ· Î³ âŠ¢ eâ€² â‡“ ğ“‹â‚‚
      -----------------------------------------------------------
      â†’ Î³ âŠ¢ (eâ‚ `app eâ‚‚) â‡“ ğ“‹â‚‚

    -- PAIR
    âŠ¢`_pair_ : âˆ€ {N} {Î³ : Î³[ N ]} {eâ‚ eâ‚‚ : Term N} {ğ“‹â‚ ğ“‹â‚‚ : ğ“‹}
      â†’ Î³ âŠ¢ eâ‚ â‡“ ğ“‹â‚
      â†’ Î³ âŠ¢ eâ‚‚ â‡“ ğ“‹â‚‚
      -----------------------------------------------------------
      â†’ Î³ âŠ¢ eâ‚ `pair eâ‚‚ â‡“ ğ“‹â‚ pair ğ“‹â‚‚

    -- PROJ1
    âŠ¢`fst : âˆ€ {N} {Î³ : Î³[ N ]} {e : Term N} {ğ“‹â‚ ğ“‹â‚‚ : ğ“‹}
      â†’ Î³ âŠ¢ e â‡“ ğ“‹â‚ pair ğ“‹â‚‚
    --------------------------------------
      â†’ Î³ âŠ¢ fst e â‡“ ğ“‹â‚

    -- PROJ2
    âŠ¢`snd : âˆ€ {N} {Î³ : Î³[ N ]} {e : Term N} {ğ“‹â‚ ğ“‹â‚‚ : ğ“‹}
      â†’ Î³ âŠ¢ e â‡“ ğ“‹â‚ pair ğ“‹â‚‚
    -----------------------------------------
      â†’ Î³ âŠ¢ snd e â‡“ ğ“‹â‚‚
